# Mandelbrot Web App - 仕様書

## 1. 概要

マンデルブロ集合を含むフラクタル図形をインタラクティブに描画・探索できるWebアプリケーション。
GitHub Pages（静的サイト）として公開する。

---

## 2. 技術スタック

| 項目 | 技術 |
|------|------|
| 描画エンジン | WebGL 2.0（フォールバック: WebGL 1.0） |
| 言語 | HTML5 + CSS3 + JavaScript（ES2020+、バニラ） |
| ビルド | 不要（ビルドレスで直接デプロイ） |
| ホスティング | GitHub Pages |

---

## 3. フラクタル種類

以下のフラクタルを切り替えて描画できる。

| # | 名前 | 数式 | 備考 |
|---|------|------|------|
| 1 | マンデルブロ集合 | z = z² + c | デフォルト |
| 2 | ジュリア集合 | z = z² + c（cは固定パラメータ） | マンデルブロ上のクリック点をcとして描画、または手動入力 |
| 3 | バーニングシップ | z = (|Re(z)| + i|Im(z)|)² + c | |
| 4 | トリコーン（マンデルバー） | z = conj(z)² + c | |

---

## 4. カラーパレット

スムースカラーリング（正規化反復回数）を基本とし、以下のプリセットを用意する。

| # | パレット名 | 概要 |
|---|-----------|------|
| 1 | クラシック（Blue-White） | 青→白→黄のグラデーション |
| 2 | ファイア | 黒→赤→黄→白 |
| 3 | レインボー | HSV色相を周期的に回転 |
| 4 | オーシャン | 紺→水色→白 |
| 5 | モノクロ | 黒→白のグレースケール |
| 6 | ネオン | 暗色背景にネオンカラー |

集合内部（収束領域）は常に黒で描画する。

---

## 5. 操作仕様

### 5.1 PC操作

| 操作 | アクション |
|------|-----------|
| ドラッグ | パン（スクロール） |
| マウスホイール | ズームイン / ズームアウト（カーソル位置中心） |
| ダブルクリック | クリック位置を中心にズームイン |
| Shift + ダブルクリック | ズームアウト |

### 5.2 スマートフォン操作

| 操作 | アクション |
|------|-----------|
| 1本指ドラッグ | パン（スクロール） |
| ピンチイン / アウト | ズームアウト / ズームイン（ピンチ中心基準） |
| ダブルタップ | タップ位置を中心にズームイン |

### 5.3 ズーム仕様

- ズーム倍率範囲: 1x 〜 10^15x（float64精度の限界付近）
- ズームステップ: ホイール1ノッチで約2倍 / 1/2倍
- ズーム時のアニメーション: 対応（CSS transform による補間 → 再描画）

---

## 6. UI構成

### 6.1 レイアウト

```
+--------------------------------------------------+
|  [≡] Mandelbrot Explorer          [JP/EN] [📷]  |  ← ヘッダーバー
+--------------------------------------------------+
|                                                    |
|                                                    |
|              フラクタル描画領域                      |
|             （Canvas / 全画面）                     |
|                                                    |
|                                                    |
+--------------------------------------------------+
|  x: -0.7435  y: 0.1314  zoom: 1.2e+06  iter: 500 |  ← 情報バー
+--------------------------------------------------+
```

### 6.2 コントロールパネル（サイドバー / ハンバーガーメニュー）

ハンバーガーメニュー [≡] をクリック/タップで開閉するスライドインパネル。

- **フラクタル種類**: ドロップダウン選択
- **カラーパレット**: サムネイル付きグリッド選択
- **最大反復回数**: スライダー（50 〜 5000、デフォルト: 500）
- **ジュリア集合パラメータ**: c の実部・虚部入力（ジュリア集合選択時のみ表示）
- **リセットボタン**: 初期表示位置に戻す
- **URL共有ボタン**: 現在の状態をURLに反映してクリップボードにコピー
- **言語切り替え**: 日本語 / English トグル

### 6.3 情報バー（フッター）

画面下部に常時表示。描画領域のスペースを最小限に圧迫するコンパクト設計。

- 現在の中心座標（実部・虚部）
- ズーム倍率
- 最大反復回数

### 6.4 レスポンシブ対応

| 画面幅 | レイアウト |
|--------|-----------|
| ≥ 768px（PC/タブレット） | コントロールパネルはサイドバー、情報バーは横1行 |
| < 768px（スマートフォン） | コントロールパネルはオーバーレイ、情報バーはコンパクト化 |

---

## 7. 追加機能

### 7.1 座標・ズーム率表示

- 情報バーにリアルタイム表示
- マウス/タッチ移動時にポインタ位置の座標も表示（PC版のみ）

### 7.2 URL共有

- URLハッシュに状態をエンコード: `#x=-0.7435&y=0.1314&z=1.2e6&type=mandelbrot&palette=fire&iter=500&lang=ja`
- 共有ボタンクリックでクリップボードにコピー + トースト通知
- ページロード時にハッシュから状態を復元

### 7.3 画像保存

- ヘッダーの [📷] ボタンでCanvas内容をPNGダウンロード
- ファイル名: `fractal_{type}_{timestamp}.png`

### 7.4 最大反復回数の調整

- スライダーUI: 50 〜 5000（対数スケール推奨）
- 変更時はリアルタイムに再描画
- ズーム倍率に応じた推奨値のオート設定オプション

---

## 8. 描画エンジン仕様

### 8.1 WebGLシェーダー

- フラグメントシェーダーでピクセル単位の並列計算
- フラクタル種類ごとにシェーダープログラムを用意（またはuniform分岐）
- スムースカラーリング: `n - log2(log2(|z|))` による正規化
- double emulation（float64精度）: 深いズーム時のfloat32精度不足に対応

### 8.2 描画フロー

1. ユーザー操作（パン/ズーム）を検出
2. CSS transformで即座にプレビュー表示（前回フレームの変形）
3. WebGLで新フレームを計算・描画
4. 完了後にCSS transformをリセットし新フレームを表示

### 8.3 パフォーマンス目標

- 初期表示: 1秒以内に描画完了（一般的なGPU搭載端末）
- パン操作: 60fps（CSS transformによる補間）
- ズーム操作後の再描画: 500ms以内

---

## 9. ファイル構成

```
mandelbrot-webapp/
├── index.html              # メインHTML
├── css/
│   └── style.css           # スタイルシート
├── js/
│   ├── app.js              # アプリケーション初期化・状態管理
│   ├── renderer.js         # WebGL描画エンジン
│   ├── shaders.js          # GLSLシェーダーソース
│   ├── controls.js         # マウス/タッチ操作ハンドリング
│   ├── ui.js               # UIコントロール・パネル管理
│   ├── palettes.js         # カラーパレット定義
│   ├── i18n.js             # 日英テキスト定義・切り替え
│   └── utils.js            # ユーティリティ関数
├── SPEC.md                 # 本仕様書
└── README.md               # プロジェクト説明（GitHub用）
```

---

## 10. ブラウザ対応

| ブラウザ | 対応 |
|---------|------|
| Chrome（最新2バージョン） | 必須 |
| Safari（最新2バージョン、iOS含む） | 必須 |
| Firefox（最新2バージョン） | 必須 |
| Edge（最新2バージョン） | 必須 |

WebGL非対応ブラウザではエラーメッセージを表示する。

---

## 11. 初期表示

- フラクタル: マンデルブロ集合
- 中心座標: (-0.5, 0)
- ズーム: 全体が収まる倍率
- カラーパレット: クラシック（Blue-White）
- 最大反復回数: 500
- 言語: ブラウザの言語設定に基づき自動判定（ja → 日本語、それ以外 → English）
